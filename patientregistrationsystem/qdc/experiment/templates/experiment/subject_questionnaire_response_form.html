{% extends "quiz/template.html" %}

{% block activePatient %}{% if origin == 'subject' %}class="active"{% endif %}{% endblock %}
{% block activeAdvancedResearchProject %}{% if origin != 'subject' %}class="active"{% endif %}{% endblock %}

{% block header %}

{% endblock %}

{% block form %}
    <div class="row">
    <form id="subject_form" method="post" data-toggle="validator">
    {% csrf_token %}
{% endblock %}

{% block content %}

    <div class="tab-pane fade in active" id="subjectBreadCrumb">
        <div class="col-md-10">
            <ol class="breadcrumb">
                <li><a href="/home">Home</a></li>
                {% if origin == 'subject' %}
                    <li><a href="/patient/find/">Participantes</a></li>

                    {% if status == "edit"%}
                        <li><a href="/patient/edit/{{ patient.id }}/?currentTab=4">{{ patient.name }}</a></li>
                    {% else %}
                        <li><a href="/patient/{{ patient.id }}/?currentTab=4">{{ patient.name }}</a></li>
                    {% endif %}

                    <li class="active">{% if creating %}Novo preenchimento{% elif completed %}Respostas{% else %}Continuar preenchimento{% endif %}</li>
                {% else %}
                    <li><a href="/experiment/research_project/list">Estudos</a></li>
                    <li><a href="/experiment/research_project/{{ group.experiment.research_project.id }}">{{ group.experiment.research_project.title }}</a></li>
                    <li><a href="/experiment/{{ group.experiment.id }}">{{ group.experiment.title }}</a></li>
                    <li><a href="/experiment/group/{{ group.id }}">{{ group.title }}</a></li>

                    {% if origin == 'experiment_subject' %}
                        <li><a href="/experiment/group/{{ group.id }}/subjects/">Participantes</a></li>
                        <li><a href="/experiment/group/{{ group.id }}/subject/{{ subject.id }}">{{ subject.patient.name }}</a></li>
                    {% else %}  {# origin == "experiment_questionnaire" #}
                        <li><a href="/experiment/group/{{ group.id }}/questionnaire/{{ questionnaire_configuration.id }}">{{ survey_title }}</a></li>
                    {% endif %}

                    <li class="active">{% if creating %}Novo preenchimento{% elif completed %}Respostas{% else %}Continuar preenchimento{% endif %}</li>
                {% endif %}
            </ol>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}

            {% if message.tags == "success" %}
                <script>showSuccessMessage('{{ message }}')</script>
            {% endif %}

            {% if message.tags == "warning" %}
                <script>showWarningMessage('{{ message }}')</script>
            {% endif %}

            {% if message.tags == "error" %}
                <script>showErrorMessage('{{ message }}')</script>
            {% endif %}

            {% if message.tags == "info" %}
                <script>showInfoMessage('{{ message }}')</script>
            {% endif %}

        {% endfor %}
    {% endif %}

    {% if FAIL == False %}
        <script>
            $(document).ready(function () {
                var elem_remove_button = undefined;
                var elem_fill_button;

                // Remove button may not exist.
                if (document.getElementById('button1') != undefined) {
                    elem_remove_button = document.getElementById('id_remove_button');
                }

                elem_fill_button = document.getElementById('id_fill_button');
                var new_window = window.open("{{ URL }}", "");

                if (new_window) {
                    if (elem_remove_button != undefined) {
                        elem_remove_button.style.display = 'none';
                    }

                    elem_fill_button.style.display = 'none';
                    new_window.focus();
                } else {
                    showErrorMessage("Não foi possível abrir o questionário. Habilite pop-ups para esse site.");

                    {# If already in the edit response page, there is no need to redirect #}
                    if (window.location.href.indexOf('edit') == -1) {
                        {# Wait 3 seconds before redirecting, so that the user can read the message. #}
                        window.setTimeout(redirect, 3000);
                    }
                }
            });

            function redirect() {
                window.open("/experiment/questionnaire_response/edit/{{ questionnaire_response_id }}", "_self");
            }

        </script>
    {% endif %}

    <div class="tab-pane fade in active" id="menuUserTab">
    <div class="col-md-10">
        <div class="container span6 offset3 well ">
            <div class="row">
                <div class="col-xs-12 col-sm-6">
                    <div class="form-group">
                        <label>Questionário</label>

                        <div class="input-group input-group-sm">
                            <span class="input-group-addon"><span
                                    class="glyphicon glyphicon-folder-open"></span></span>
                            <input class="form-control" id="id_survey_title" name="survey_title"
                                   value="{{ survey_title }}"
                                   type="text" disabled>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-6">
                    <div class="form-group">
                        <label>Participante</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
                            {% if origin == 'subject' %}
                                <input class="form-control" id="id_subject" name="subject"
                                       value="{{ patient.name }}" type="text" disabled>
                            {% else %}
                                <input class="form-control" id="id_subject" name="subject"
                                       value="{{ subject.patient.name }}" type="text" disabled>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-6">
                    <div class="form-group">
                        <label>Responsável pelo preenchimento</label>

                        <div class="input-group input-group-sm">
                                <span class="input-group-addon"><span
                                        class="glyphicon glyphicon-user"></span></span>
                            <input class="form-control" id="id_responsible" name="responsible"
                                   value="{{ questionnaire_responsible }}" type="text" disabled>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-6">
                    <div class="form-group {% if questionnaire_response_form.errors.date %}has-error{% endif %}">
                        <label for="fill_date" class="control-label">Data de preenchimento<b
                                style="color: red;">*</b></label>

                        <div class="input-group input-group-sm">
                            <span class="input-group-addon"> <span class="glyphicon glyphicon-th"></span></span>
                            {% if completed or not creating %}
                                <input class="form-control" id="fill_date"
                                       value="{{ questionnaire_response_form.date.value|date:"d/m/Y" }}" type="text"
                                       disabled>
                            {% else %}
                                {{ questionnaire_response_form.date }}
                            {% endif %}
                        </div>
                        <div class="help-block with-errors">
                            {% if questionnaire_response_form.date.errors %}
                                <span>
                                    {% for error in questionnaire_response_form.date.errors %}
                                        {{ error }}{% endfor %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if completed %}
            <div class="container span6 offset3 well ">
                <div class="col-md-10">
                    {% for question_response in questionnaire_responses %}
                        <div class="row">
                            <div class="col-xs-12 col-sm-12">
                                <div class="form-group">
                                    <div class="input-group input-group-sm">
                                        <label>{{ question_response.question }}</label>
                                        {% if question_response.type == 'M' %}
                                            {% if question_response.answer == 'Y'%}
                                                <br/><input type="checkbox" value="answer" checked disabled>
                                            {% else %}
                                                <br/><input type="checkbox" value="answer" disabled>
                                            {% endif %}
                                        {% else %}
                                            {% if question_response.type == 'D' %}
                                                <input class="form-control" value="{{ question_response.answer|date:"d/m/Y" }}" type="text" disabled>
                                            {% else %}
                                                {% if question_response.type == '1' %}
                                                    {% for answer in question_response.answer %}
                                                        {% if answer != '' %}
                                                            <input class="form-control" value="{{ answer }}" type="text" disabled>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {% if question_response.answer != '' %}
                                                        <input class="form-control" value="{{ question_response.answer }}" type="text" disabled>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="btn-toolbar">
            <div class="btn-group pull-left">
                {% if not creating %}
                    {# As it is not possible to create complex boolean experssions, the code to create a remove button had to be duplicated. #}
                    {% if origin == 'subject' %}
                        {% if perms.patient.delete_questionnaireresponse %}
                            <button type="button" id="id_remove_button" class="btn btn-danger" onclick="$('#modalRemove').modal('show')">Excluir</button>
                        {% endif %}
                    {% else %}
                        {% if perms.experiment.delete_questionnaireresponse and can_change %}
                            <button type="button" id="id_remove_button" class="btn btn-danger" onclick="$('#modalRemove').modal('show')">Excluir</button>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>

            <div class="btn-group pull-right">
                {% if not completed %}
                    {% if can_change %}
                        {% if creating %}
                            {# As it is not possible to create complex boolean experssions, the code to create a new fill button had to be duplicated. #}
                            {% if origin == 'subject' %}
                                {% if perms.patient.add_questionnaireresponse %}
                                    <button type="submit" id="id_fill_button" name="action" value="save" class="btn btn-primary">Novo preenchimento</button>
                                {% endif %}
                            {% else %}
                                {% if perms.experiment.add_questionnaireresponse %}
                                    <button type="submit" id="id_fill_button" name="action" value="save" class="btn btn-primary">Novo preenchimento</button>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {# As it is not possible to create complex boolean experssions, the code to create an update fill button had to be duplicated. #}
                            {% if origin == 'subject' %}
                                {% if perms.patient.change_questionnaireresponse %}
                                    <button type="submit" id="id_fill_button" name="action" value="save" class="btn btn-primary">Continuar preenchimento</button>
                                {% endif %}
                            {% else %}
                                {% if perms.experiment.change_questionnaireresponse %}
                                    <button type="submit" id="id_fill_button" name="action" value="save" class="btn btn-primary">Continuar preenchimento</button>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
            <div class="btn-group pull-right">
                {% if origin == 'subject' %}
                    <a href="/patient{% if status == 'edit' %}/edit{% endif %}/{{ patient.id }}/?currentTab=4" class="btn" style="background-color: #f5f5f5">Voltar</a>
                {% else %}
                    {% if origin == 'experiment_subject' %}
                        <a href="/experiment/group/{{ group.id }}/subject/{{ subject.id }}" class="btn"
                           style="background-color: #f5f5f5">Voltar</a>
                    {% else %} {# origin == 'experiment_questionnaire' #}
                        <a href="/experiment/group/{{ group.id }}/questionnaire/{{ questionnaire_configuration.id }}"
                           class="btn" style="background-color: #f5f5f5">Voltar</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>

    </div>

    {# As it is not possible to create complex boolean experssions, the code of the modalRemove had to be duplicated. #}
    {% if not creating %}
        {% if origin == 'subject' %}
            {% if perms.patient.delete_questionnaireresponse %}
                <div class="modal fade" id="modalRemove" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-body">
                                Tem certeza que deseja excluir o preenchimento deste questionário?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-danger" value="remove" name="action">Excluir</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            {% if perms.experiment.delete_questionnaireresponse and can_change %}
                <div class="modal fade" id="modalRemove" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-body">
                                Tem certeza que deseja excluir o preenchimento deste questionário?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-danger" value="remove" name="action">Excluir</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endif %}

{% endblock %}

{% block end_form %}
    </form>
    </div>
{% endblock %}
